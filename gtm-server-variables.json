{
  "variables": [
    {
      "name": "dl_user_data_email",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.email"
        }
      ]
    },
    {
      "name": "dl_user_data_phone",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.phone"
        }
      ]
    },
    {
      "name": "dl_user_data_firstName",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.firstName"
        }
      ]
    },
    {
      "name": "dl_user_data_lastName",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.lastName"
        }
      ]
    },
    {
      "name": "dl_user_data_city",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.city"
        }
      ]
    },
    {
      "name": "dl_user_data_state",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.state"
        }
      ]
    },
    {
      "name": "dl_user_data_zip",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.zip"
        }
      ]
    },
    {
      "name": "dl_user_data_country",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data_raw.country"
        }
      ]
    },
    {
      "name": "dl_user_data_fbc",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data.fbc"
        }
      ]
    },
    {
      "name": "dl_user_data_fbp",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data.fbp"
        }
      ]
    },
    {
      "name": "dl_user_data_external_id",
      "type": "dlv",
      "parameter": [
        {
          "type": "INTEGER",
          "key": "dataLayerVersion",
          "value": "2"
        },
        {
          "type": "BOOLEAN",
          "key": "setDefaultValue",
          "value": "false"
        },
        {
          "type": "TEMPLATE",
          "key": "name",
          "value": "user_data.external_id"
        }
      ]
    },
    {
      "name": "hashed_email",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var email = {{dl_user_data_email}};\n  if (!email) return '';\n  \n  // Normalizar email\n  email = email.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(email);\n}"
        }
      ]
    },
    {
      "name": "hashed_phone",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var phone = {{dl_user_data_phone}};\n  if (!phone) return '';\n  \n  // Normalizar telefone - remover caracteres não numéricos\n  phone = phone.replace(/\\D/g, '');\n  \n  // Hash SHA-256\n  return sha256(phone);\n}"
        }
      ]
    },
    {
      "name": "hashed_firstName",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var firstName = {{dl_user_data_firstName}};\n  if (!firstName) return '';\n  \n  // Normalizar nome\n  firstName = firstName.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(firstName);\n}"
        }
      ]
    },
    {
      "name": "hashed_lastName",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var lastName = {{dl_user_data_lastName}};\n  if (!lastName) return '';\n  \n  // Normalizar sobrenome\n  lastName = lastName.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(lastName);\n}"
        }
      ]
    },
    {
      "name": "hashed_city",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var city = {{dl_user_data_city}};\n  if (!city) return '';\n  \n  // Normalizar cidade\n  city = city.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(city);\n}"
        }
      ]
    },
    {
      "name": "hashed_state",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var state = {{dl_user_data_state}};\n  if (!state) return '';\n  \n  // Normalizar estado\n  state = state.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(state);\n}"
        }
      ]
    },
    {
      "name": "hashed_zip",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var zip = {{dl_user_data_zip}};\n  if (!zip) return '';\n  \n  // Normalizar CEP\n  zip = zip.replace(/\\D/g, '');\n  \n  // Hash SHA-256\n  return sha256(zip);\n}"
        }
      ]
    },
    {
      "name": "hashed_country",
      "type": "jsm",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "javascript",
          "value": "function() {\n  var country = {{dl_user_data_country}};\n  if (!country) return '';\n  \n  // Normalizar país\n  country = country.toLowerCase().trim();\n  \n  // Hash SHA-256\n  return sha256(country);\n}"
        }
      ]
    }
  ],
  "tags": [
    {
      "name": "SHA-256 Library",
      "type": "html",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "html",
          "value": "<script>\n// SHA-256 Implementation for GTM Server-side\nfunction sha256(ascii) {\n  function rightRotate(value, amount) {\n    var tmp = (value & 0xFFFFFFFF) << (32 - amount);\n    return (value >>> amount) | tmp;\n  };\n\n  function mathPow(x, n) {\n    if (n < 0) return 0;\n    if (n === 0) return 1;\n    if (n === 1) return x;\n    if (n % 2 === 0) return mathPow(x * x, n / 2);\n    return x * mathPow(x * x, (n - 1) / 2);\n  };\n\n  var maxWord = mathPow(2, 32);\n  var lengthProperty = 'length';\n  var i, j;\n  var result = '';\n\n  var words = [];\n  var asciiBitLength = ascii[lengthProperty] * 8;\n\n  var hash = sha256.h = sha256.h || [];\n  var k = sha256.k = sha256.k || [];\n  var primeCounter = k[lengthProperty];\n\n  var isComposite = {};\n  for (var candidate = 2; primeCounter < 64; candidate++) {\n    if (!isComposite[candidate]) {\n      for (i = 0; i < 313; i += candidate) {\n        isComposite[i] = candidate;\n      }\n      hash[primeCounter] = (mathPow(candidate, 0.5) * maxWord) | 0;\n      k[primeCounter++] = (mathPow(candidate, 1 / 3) * maxWord) | 0;\n    }\n  }\n\n  ascii += '\\x80';\n  while (ascii[lengthProperty] % 64 - 56) ascii += '\\x00';\n  for (i = 0; i < ascii[lengthProperty]; i++) {\n    j = ascii.charCodeAt(i);\n    if (j >> 8) return;\n    words[i >> 2] |= j << ((3 - i) % 4) * 8;\n  }\n  words[words[lengthProperty]] = ((asciiBitLength / maxWord) | 0);\n  words[words[lengthProperty]] = (asciiBitLength);\n\n  for (j = 0; j < words[lengthProperty];) {\n    var w = words.slice(j, j += 16);\n    var oldHash = hash.slice(0);\n\n    hash = hash.slice(0, 8);\n\n    for (i = 0; i < 64; i++) {\n      var i2 = i + j;\n      var w15 = w[i - 15], w2 = w[i - 2];\n\n      var a = hash[0], e = hash[4];\n      var temp1 = hash[7]\n        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))\n        + ((e & hash[5]) ^ ((~e) & hash[6]))\n        + k[i]\n        + (w[i] = (i < 16) ? w[i] : (w[i - 16]\n        + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15 >>> 3))\n        + w[i - 7]\n        + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2 >>> 10))) | 0\n      );\n      var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))\n        + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]));\n\n      hash = [(temp1 + temp2) | 0].concat(hash);\n      hash[4] = (hash[4] + temp1) | 0;\n    }\n\n    for (i = 0; i < 8; i++) {\n      hash[i] = (hash[i] + oldHash[i]) | 0;\n    }\n  }\n\n  for (i = 0; i < 8; i++) {\n    for (j = 3; j + 1; j--) {\n      var b = (hash[i] >> (j * 8)) & 255;\n      result += ((b < 16) ? 0 : '') + b.toString(16);\n    }\n  }\n  return result;\n}\n</script>"
        }
      ],
      "firingTriggerId": [
        "2147479553" // All Pages trigger
      ]
    },
    {
      "name": "Facebook Conversions API - Initiate Checkout",
      "type": "caw",
      "parameter": [
        {
          "type": "BOOLEAN",
          "key": "sendConversionData",
          "value": "true"
        },
        {
          "type": "TEMPLATE",
          "key": "eventName",
          "value": "InitiateCheckout"
        },
        {
          "type": "TEMPLATE",
          "key": "pixelId",
          "value": "642933108377475"
        },
        {
          "type": "TEMPLATE",
          "key": "accessToken",
          "value": "[SEU_ACCESS_TOKEN_AQUI]"
        },
        {
          "type": "LIST",
          "key": "userData",
          "list": [
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "em"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_email}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "ph"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_phone}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "fn"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_firstName}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "ln"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_lastName}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "ct"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_city}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "st"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_state}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "zp"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_zip}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "country"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{hashed_country}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "fbc"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{dl_user_data_fbc}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "fbp"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{dl_user_data_fbp}}"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "external_id"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "{{dl_user_data_external_id}}"
                }
              ]
            }
          ]
        },
        {
          "type": "LIST",
          "key": "customData",
          "list": [
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "content_name"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "Sistema de Controle de Trips - Maracujá"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "content_ids"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "[\"6080425\"]"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "content_type"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "product"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "value"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "39.90"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "currency"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "BRL"
                }
              ]
            },
            {
              "type": "MAP",
              "map": [
                {
                  "type": "TEMPLATE",
                  "key": "name",
                  "value": "num_items"
                },
                {
                  "type": "TEMPLATE",
                  "key": "value",
                  "value": "1"
                }
              ]
            }
          ]
        },
        {
          "type": "BOOLEAN",
          "key": "enableEventId",
          "value": "true"
        },
        {
          "type": "TEMPLATE",
          "key": "eventId",
          "value": "{{event_id}}"
        }
      ],
      "firingTriggerId": [
        "2147479554" // Initiate Checkout Event trigger
      ],
      "tagFiringOption": "ONCE_PER_EVENT"
    }
  ],
  "triggers": [
    {
      "name": "All Pages",
      "type": "PAGEVIEW"
    },
    {
      "name": "Initiate Checkout Event",
      "type": "CUSTOM_EVENT",
      "customEventFilter": [
        {
          "type": "EQUALS",
          "arg0": {
            "type": "TEMPLATE",
            "value": "{{_event}}"
          },
          "arg1": {
            "type": "TEMPLATE",
            "value": "initiate_checkout"
          }
        }
      ]
    }
  ],
  "clients": [
    {
      "name": "Facebook Server-side API",
      "type": "caw",
      "parameter": [
        {
          "type": "TEMPLATE",
          "key": "pixelId",
          "value": "642933108377475"
        },
        {
          "type": "TEMPLATE",
          "key": "accessToken",
          "value": "[SEU_ACCESS_TOKEN_AQUI]"
        }
      ]
    }
  ]
}